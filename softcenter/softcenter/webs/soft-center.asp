<title>软件中心</title>
<content>
<style type="text/css">
::-webkit-scrollbar-track {
	-webkit-box-shadow:inset 0 0 6px rgba(0, 0, 0, 0.3);
	border-radius:10px;
	background-color:#F5F5F5;
}
::-webkit-scrollbar {
	width:8px;
	background-color:#F5F5F5;
}
::-webkit-scrollbar-thumb {
	border-radius:10px;
	-webkit-box-shadow:inset 0 0 6px rgba(0, 0, 0, .3);
	background-color:#555;
}
.box .content {
	padding:0 15px 15px;
	display:block;
}

.popover {
	font-size:14px;
	color:#63B8FF;
}
.apps a:link {
	color:#fff
}
.apps a:visited {
	color:#fff
}
.apps a:hover {
	color:#fff
}
.apps a:active {
	color:#fff
}
.apps {
	color:#fff;
	width:250px;
	height:100px;
	text-align:left;
	float:left;
	margin:5px;
	border-radius:5px;
	filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale')";
	-moz-background-size:100% 100%;
	background-size:100% 100%;
	cursor:pointer;
}
.infos {
	width:80px;
	height:100px;
	float:left;
}
.appimg {
	width:60px;
	margin:20px 10px 20px 10px;
	pointer-events:none;
}
.app-name {
	padding:11px 0 11px 0;
	height:100px;
	width:170px;
	float:left;
}
.app-name p {
	text-overflow:ellipsis;
	overflow:hidden;
	white-space:nowrap;
	text-shadow:1px 1px 3px #000000, 0 0 3px #030303;
	padding-left:2px;
	pointer-events:none;
}
.appDesc {
	margin:0 auto;
	width:40px;
	height:100px;
	float:left;
	display:none;
}
.appDesc button.btn {
	width:35px;
	height:100px;
	font-family:"Segoe UI", "Roboto", sans-serif;
	font-weight:400!important;
	vertical-align:middle;
	outline:0;
	outline-style:none;
	font-size:14px;
	padding:0 3px 0 3px;
	border-radius:0px;
}
.box, .boxr1 {
	background: #f9fbfb;
}
.boxr2 {
	display:none;
	background: #f9fbfb;
}
.boxr3 {
	display:none;
	background: #f9fbfb;
}
.boxr4 {
	display:none;
	background: #f9fbfb;
}
.boxr5 {
	display:none;
	background: #f9fbfb;
}
#push_content3 {
	display:none;
}
#push_content4 {
	display:none;
}
.backsoftcenter {
	margin-right:20px;
	margin-top:-30px;
}
.soft_log {
	margin-top:50px;
	margin-left:15px;
}
.loader {
	width:65px;
	height:5px;
	margin-top:8px;
	float:left;
	border:0px solid #3498db;
	box-sizing:border-box;
	display:flex;
	align-items:center;
	justify-content:center;
}
@-webkit-keyframes loading-2 {
	0% {
		transform:scaleY(1);
		-moz-transform:scaleY(1);
		-webkit-transform:scaleY(1);
	}
	50% {
		transform:scaleY(.4);
		-moz-transform:scaleY(.4);
		-webkit-transform:scaleY(.4);
	}
	100% {
		transform:scaleY(1);
		-moz-transform:scaleY(1);
		-webkit-transform:scaleY(1);
	}
}
.loading-2 i {
	display:inline-block;
	width:4px;
	height:12px;
	border-radius:2px;
	background:#3498db;
	margin:0 2px;
}
.loading-2 i:nth-child(1) {
	-webkit-animation:loading-2 1s ease-in .1s infinite;
	-moz-animation:loading-2 1s ease-in .1s infinite;
	animation:loading-2 1s ease-in .1s infinite;
}
.loading-2 i:nth-child(2) {
	-webkit-animation:loading-2 1s ease-in .2s infinite;
	-moz-animation:loading-2 1s ease-in .2s infinite;
	animation:loading-2 1s ease-in .2s infinite;
}
.loading-2 i:nth-child(3) {
	-webkit-animation:loading-2 1s ease-in .3s infinite;
	-moz-animation:loading-2 1s ease-in .3s infinite;
	animation:loading-2 1s ease-in .3s infinite;
}
.loading-2 i:nth-child(4) {
	-webkit-animation:loading-2 1s ease-in .4s infinite;
	-moz-animation:loading-2 1s ease-in .4s infinite;
	animation:loading-2 1s ease-in .4s infinite;
}
.loading-2 i:nth-child(5) {
	-webkit-animation:loading-2 1s ease-in .5s infinite;
	-moz-animation:loading-2 1s ease-in .5s infinite;
	animation:loading-2 1s ease-in .5s infinite;
}
ul.nav-tabs {
	display:block;
	height:40px;
	list-style:none;
	margin:0 0 15px!important;
	white-space:nowrap;
	border-bottom:2px solid rgba(0, 0, 0, 0.08);
	background:#f9fbfb;
	float: none;
	padding: 0
}
ul.nav-tabs li {
	display:inline-block;
	float:left;
	height:40px;
	line-height:40px;
	margin:0!important
}
ul.nav-tabs li a {
	display:block;
	padding:0 15px;
	height:40px;
	font-weight:normal;
	line-height:40px;
	color:#808080;
	text-shadow:0 1px 0 rgba(255, 255, 255, 0.2);
	transition:all 100ms ease;
	-webkit-transition:all 100ms ease;
	border-bottom:1px solid transparent
}
ul.nav-tabs li a.active, ul.nav-tabs li a:focus, ul.nav-tabs li a:hover {
	z-index:999;
	color:#777777;
	background:rgba(0, 0, 0, 0.05);
	border-bottom:2px solid rgba(0, 0, 0, 0.05)
}
ul.nav-tabs li a.active {
	border-bottom:2px solid #3498DB;
	background:transparent
	outline:none;
}
ul.nav-tabs li a i {
	margin-right:2px
}
ul.pullmsg > li{
	line-height: 180%;
}
.box .heading {
	display:block;
	font-size:16px;
	font-weight:500;
	line-height:normal;
	color:#656565;
	padding:15px 10px 15px 20px;
	vertical-align:middle
}
.box .heading small {
	margin-left:5px
}
.box .heading a {
	color:#838c91;
	margin:-8px 0 0 0;
	padding:8px 12px;
	border-radius:50%;
	-webkit-transition:color 150ms ease-out;
	transition:color 150ms ease-out
}
.box .heading a:hover {
	color:#3498db
}
#version > a {
    color: #6d140b;
    padding: 0px 0px;
}
#version > a:hover, a:active {
    color: #f36c21;
}
</style>
<script type="text/javascript" src="/js/advancedtomato.js"></script>
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/tomato.js"></script>
<script type="text/javascript" src="/layer/layer.js"></script>
<script type="text/javascript">
var anmstatus=null;
var softcenter = 1;
var _responseLen;
var noChange = 0;
function change1(obj){
	x = $(anmstatus).find('.app-name').width();
	if(x == '170px'){
		anmstatus = null;
	}
	if(anmstatus != obj){
		anmstatus = obj;
		$(obj).stop().removeClass('animated flipInY').addClass('animated flipInY').one('animationend webkitAnimationEnd oAnimationEnd', function(){
			$(obj).removeClass('animated flipInY');
    	});	
	}
	$(obj).find('.appDesc').show();
	$(obj).find('.app-name').width('130px');
}
function change2(obj){
	var id = $(obj).find('button').attr("id");
	if(id != 'app-update'){
		$(obj).find('.appDesc').hide();
		$(obj).find('.app-name').width('170px');
	}else{
		$(obj).find('.app-name').width('130px');
	}
}
function tabSelect(obj){
	var tableX = ['app1-server1-basic-tab','app2-server1-advanced-tab','app3-server1-keys-tab', 'app5-server1-adv-tab', 'app4-server1-status-tab'];
	var boxX = ['boxr1','boxr2','boxr3', 'boxr5','boxr4'];
	var appX = ['app1','app2','app3', 'app5','app4'];
	for (var i = 0; i < tableX.length; i++){
		if(obj == appX[i]){
			$('#'+tableX[i]).addClass('active');
			$('.'+boxX[i]).show();
		}else{
			$('#'+tableX[i]).removeClass('active');
			$('.'+boxX[i]).hide();
		}
	}
}
var currState = {"installing": false, "lastChangeTick": 0, "lastStatus": "-1", "module":""};
var softcenterUrl = "https://ledesoft.ddnsto.com";
var dataTypeX = "jsonp";
var softInfo = {};
var appsInfo;
var TimeOut = 0;
var Msginfos = [
	"操作失败",
	"已安装",
	"初始化中...",
	"正在下载...",
	"正在安装中...",
	"安装成功！请等待浏览器跳转！",
	"卸载中......",
	"卸载成功！请等待浏览器跳转",
	"没有检测到在线版本号！",
	"正在下载更新......",
	"正在安装更新...",
	"安装更新成功，请等待浏览器跳转！ ",
	"下载文件校验不一致！",
	"然而并没有更新！",
	"正在检查是否有更新~",
	"检测更新错误！"
];
$.ajax({
	url: "https://ledesoft.ddnsto.com/softcenter/switch_server.json.js",
	type: "GET",
	dataType: 'jsonp',
	success: function() {
		$('#server').html('服务器：LEDESoft');
		notice_show();
		softCenterInit();
	},
	error: function() {
		$('#server').html('服务器：访问故障');
		notice_show();
		softCenterInit();
	},
	timeout: 5000
});
function notice_show(){
	$.ajax({
		url: softcenterUrl+'/softcenter/push_message.json.js',
		type: 'GET',
		dataType: dataTypeX,
		success: function(res) {
			$("#push_titile").html(res.title);
			$("#push_content1").html(res.content1);
			$("#push_content2").html(res.content2);
			if(res.content3){
				$("#push_content3").show();
				$("#push_content3").html(res.content3);
			}
			if(res.content4){
				$("#push_content4").show();
				$("#push_content4").html(res.content4);
			}
		}
	});
}

function verifyFields (){
	return true;
}
function appinstall(obj){
	var name = obj.value;
	_formatData(name,'install');
}
function appuninstall(obj){
	var name = obj.value;
	var xxx = {"name":name};
	appUninstallModule(xxx);
}
function appupdata(obj){
	var name = obj.value;
	_formatData(name,'install');
}
function appInstallModule(moduleInfo){
	appPostScript(moduleInfo, "ks_app_install.sh");
}
function appUninstallModule(moduleInfo){
	layer.confirm('确定卸载吗？', {
		shade: 0.8,
		btn: ['确定', '不确定']
	}, function() {
		layer.msg('开始卸载！', {
			shade: 0.8,
			icon: 5
		});
		appPostScript(moduleInfo, "ks_app_remove.sh");
	});
}
function _formatData(name,mod){
	$('button').addClass('disabled');
	$('button').prop('disabled', true);
	for(var aname in softInfo){
		if(aname.indexOf(name) > 0 ){
			app_name = softInfo[aname];
			if(mod=="install" && name == app_name){
				var xxx = {
					"name":app_name,
					"md5": softInfo['app_'+app_name+'_md5'],
					"tar_url": softInfo['app_'+app_name+'_tar_url'],
					"version": softInfo['app_'+app_name+'_oversion'],
					"title":softInfo['app_'+app_name+'_title']
				};
				appInstallModule(xxx);
				return;
			}			
		}
	};
}
function get_overlay_status(){
	var id = parseInt(Math.random() * 100000000);
	var postData = {"id": id, "method": "ks_overlay_status.sh", "params":[], "fields": ""};
	$.ajax({
		type: "POST",
		url: "/_api/",
		async:true,
		cache:false,
		data: JSON.stringify(postData),
		dataType: "json",
		success: function(response){
			if (response.result != -1){
				var ot = response.result.split(">")[0] + " MB";
				var ou = response.result.split(">")[1] + " MB";
				var op = Math.round(parseInt(ou) / parseInt(ot) * 1000) / 10.00;
				var info = "已用空间：" + ou + " / " + ot + " (" + op + "%)";
				$("#overlay_status").show();
				$("#overlay_status_text").attr("title", info);
				$("#overlay_status_text div").attr("style", "width: " + op + "%;");
			}
		}
	});
}
function getSoftCenter(obj){
	$.ajax({
		url:softcenterUrl+"/softcenter/app.json.js",
		dataType:dataTypeX,  
		method: 'GET',
		async: true,
		cache: false,
		success:function(re) {
			var appObject={};
			var vhtml1 = "";
			var vhtml2 = "";
			var appButton = "";
			soft = re.apps;
			get_overlay_status();
			onlineversion = re.version;
			locversion = obj["softcenter_version"];
			$("#loading").hide();
			$(".loader").show();
			if (locversion != onlineversion) {
				$("#update").show();
					layer.open({
						type: 1,
						title: false,
						closeBtn: false,
						area: '500px;',
						shade: 0.8,
						scrollbar: false,
						id: 'LAY_layuipro',
						btn: ['火速更新', '更新个毛'],
						btnAlign: 'c',
						moveType: 1,
						content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">\
									<b>欢迎来到koolshare软件中心！</b><br><br><br>\
									如你所见，LEDE-X64软件中心又双叒叕更新了！<br>\
									软件中心更新至' + re.version + '~<br><br>\
									● 更新日志详情<a style="color:#33CCCC" target="_blank" href="https://github.com/koolshare/ledesoft/blob/master/softcenter/Changelog.txt">请戳我了解~</a><br>\
									● 赶快更新吧，少年！<br><br>\
									我们的征途是星辰大海 ^_^</div>',
						success: function(layero) {
							var btn = layero.find('.layui-layer-btn');
							$(".layui-layer-btn0").click(function () {
								var moduleInfo = {
									"name":"softcenter",
									"md5": re.md5,
									"tar_url": re.tar_url,
									"version": re.version
								};
								appPostScript(moduleInfo, "ks_app_install.sh");
							});
						}
					});
			}
			$("#version").html("当前版本：" + locversion + " , 线上版本：" + onlineversion + '\
								&nbsp;&nbsp;【<a href="https://github.com/koolshare/ledesoft/blob/master/softcenter/Changelog.txt" target="_blank"><u>更新日志</u></a>】\
								&nbsp;&nbsp;【问题反馈:<a href="https://github.com/koolshare/ledesoft" target="_blank">&nbsp;&nbsp;<u>github</u></a>\
								<a href="https://t.me/joinchat/DCq55kMMVu3lngw1wY6Zng" target="_blank">&nbsp;&nbsp;<u>telegram</u></a>\
								<a href="http://koolshare.cn/forum-97-1.html" target="_blank">&nbsp;&nbsp;&nbsp;<u>koolshare</u></a>】\
								');
								
			var object = $.extend([],obj, soft);
			
			var j=0;
			var x=0;
			for(var name in object){
				if(name.indexOf("name") > 0 ){
					app_name = object[name];
					appObject["app_"+app_name+"_name"] = object['softcenter_module_'+app_name+'_name'];
					appObject["app_"+app_name+"_title"] = object['softcenter_module_'+app_name+'_title'];
					appObject["app_"+app_name+"_home_url"] = object['softcenter_module_'+app_name+'_home_url'];
					appObject["app_"+app_name+"_version"] = object['softcenter_module_'+app_name+'_version'];
					appObject["app_"+app_name+"_description"] = object['softcenter_module_'+app_name+'_description'];
					appObject["app_"+app_name+"_changelog"] = object['softcenter_module_'+app_name+'_changelog'];
					appObject["app_"+app_name+"_install"] = object['softcenter_module_'+app_name+'_install'];
				}
			};
			for(var i=0; i < object.length; i++) {  
				o_name = object[i]["name"];
				o_title = object[i]["title"];
				o_home_url = object[i]["home_url"];
				o_tar_url = object[i]["tar_url"];
				o_version = object[i]["version"];
				o_md5 = object[i]["md5"];
				o_description = object[i]["description"];
				o_changelog = object[i]["changelog"]||"";
				o_description = object[i]["description"]||"暂无描述";

				appObject["app_"+o_name+"_name"] = o_name;
				appObject["app_"+o_name+"_title"] = o_title;
				appObject["app_"+o_name+"_home_url"] = o_home_url;
				appObject["app_"+o_name+"_tar_url"] = o_tar_url;
				appObject["app_"+o_name+"_oversion"] = o_version;
				appObject["app_"+o_name+"_description"] = o_description;
				appObject["app_"+o_name+"_changelog"] = o_changelog;
				appObject["app_"+o_name+"_md5"] = o_md5;
			};
			softInfo = appObject;
			for(var name in appObject){
				if(name.indexOf("name") > 0 ){
					var appname = appObject[name];
					title = appObject["app_"+appname+"_title"];
					version = appObject["app_"+appname+"_version"];
					install = appObject["app_"+appname+"_install"];
					oversion = appObject["app_"+appname+"_oversion"];
					description = appObject["app_"+appname+"_description"];
					if(!title){
						title = appname;
					}
					if(description=="" || !description){
						description="暂无描述";
					}
					if(install=="1" || install=="2"){
						j++;
						aurl = "#/Module_" +appname+".asp";
						if(oversion!=version && oversion){
							appButton = '<button value="'+appname+'" onclick="appupdata(this)" id="app-update" class="btn btn-success">更新</button>';
							description = appObject["app_"+appname+"_changelog"] || appObject["app_"+appname+"_description"];
						}else{
							appButton = '<button type="button" value="'+appname+'" onclick="appuninstall(this)" class="btn btn-danger">卸载</button>';
						}
						appimg1 = softcenterUrl+"/softcenter/softcenter/webs/res/icon-"+appname+".png";
						bgimg1 = softcenterUrl+"/softcenter/softcenter/webs/res/icon-"+appname+"-bg.png";
						bgimg = '/res/icon-'+appname+'-bg.png';
						appimg = '/res/icon-'+appname+'.png';
						vhtml1 += '<div class="apps" style="background:url('+bgimg1+'), url('+bgimg+');" onmouseover="change1(this);" onmouseout="change2(this);">'+
						'<a href="'+aurl+'" title="'+title+'\n'+description+'">'+
							'<div class="infos">'+
								'<img class="appimg" src="'+appimg1+'" onerror="this.onerror=null;this.src=\'' + appimg + '\';"/></div>'+
								'<div class="app-name"><p style="margin-top:13px">'+title+'</p><p style="margin-top:13px">'+description+'</p></div>'+
							'</a>'+
							'<div class="appDesc">'+
							appButton+
							'</div>'+
						'</div>';
						appButton="";
					}else{
						x++;
						appimg = softcenterUrl+"/softcenter/softcenter/webs/res/icon-"+appname+".png";
						bgimg = softcenterUrl+"/softcenter/softcenter/webs/res/icon-"+appname+"-bg.png";
						appButton = '<button type="button" value="'+appname+'" onclick="appinstall(this)" class="btn btn-primary">安装</button>';
						vhtml2 += '<div title="'+title+'\n'+description+'" class="apps" style="background:url('+bgimg+');" onmouseover="change1(this);" onmouseout="change2(this);">'+
							'<div class="infos">'+
								'<img class="appimg" src="'+appimg+'"/></div>'+
								'<div class="app-name"><p>'+title+'</p>'+
								'<p>'+description+'</p></div>'+
							'<div class="appDesc">'+
							appButton+
							'</div>'+
						'</div>';
						appButton="";
					}
				}
			};
			$(".tabContent1").html(vhtml1);
			$(".tabContent2").html(vhtml2);
			vhtml1="";
			vhtml2="";
			$("#app1-server1-basic-tab").html('<i class="icon-system"></i> 已安装（'+j+'）');
			$("#app2-server1-advanced-tab").html('<i class="icon-globe"></i> 未安装（'+x+'）');
			//软件中心更新 start
			if (onlineversion != locversion){
				$("#update").click(function () {
					var moduleInfo = {
						"name":"softcenter",
						"md5": re.md5,
						"tar_url": re.tar_url,
						"version": re.version
					};
					appPostScript(moduleInfo, "ks_app_install.sh");
				});
			}
			if(($('.btn.btn-success'))){
				var update_soft = $('.btn.btn-success').parent('DIV.appDesc').parent();
				change1(update_soft);
			}
			var normal_soft = $('.btn.btn-danger').parent('DIV.appDesc').parent();
			change1(normal_soft);
			change2(normal_soft);
		},
		error :function(data){
			$("#loading").hide();
			$('#server').html('网络异常！');
			$("#version").html("<font color='#FF6A6A'>X 线上服务器超时 , 请稍后重试……</font>");
			getLocalApp(obj)
		},
		timeout:5000
	});
}
function getLocalApp(obj){
	var vhtml1 ="";
	var j=0;
	for(var p in obj) {
		if(p.indexOf("name") > 0 ){  
			j++;
			var appButton="";
			name = obj[p];
			aurl = "#/Module_" + name+".asp";
			description = "本地版本："+obj["softcenter_module_"+name+"_version"];
			appimg = "/res/icon-"+name+".png";
			bgimg = "/res/icon-"+name+"-bg.png";
			appButton = '<button type="button" value="'+name+'" onclick="appuninstall(this)" class="btn btn-danger">卸载</button>';
			vhtml1 += '<div class="apps" style="background:url('+bgimg+');" onmouseover="change1(this);" onmouseout="change2(this);"><a href="'+aurl+'" title="'+name+'\n'+description+'"><div class="infos"><img class="appimg" src="'+appimg+'"/></div><div class="app-name"><p>'+name+'</p><p>'+description+'</p></div></a><div class="appDesc">'+appButton+'</div></div>';
		}  						
	}
	$("#app1-server1-basic-tab").html('<i class="icon-system"></i> 已安装（'+j+'）');
	$(".tabContent1").html(vhtml1);
}
function appPostScript(moduleInfo, script) {
	var id = 1 + Math.floor(Math.random() * 6);
	var data = {};
	var applyUrl = "/_api/";
	if(script =="ks_tar_install.sh"){
		data["soft_name"] = moduleInfo.name;
		data["soft_install_version"] = moduleInfo.version;
	}else{
		data["softcenter_home_url"] = softcenterUrl;
		data["softcenter_installing_todo"] = moduleInfo.name;
	}
	
	if(script == "ks_app_install.sh") {
		data["softcenter_installing_tar_url"] = moduleInfo.tar_url;
		data["softcenter_installing_md5"] = moduleInfo.md5;
		data["softcenter_installing_version"] = moduleInfo.version;
		data[moduleInfo.name + "_title"] = moduleInfo.title;
	}
	
	var postData = {"id": id, "method":script, "params":[], "fields": data};
	
	var success = function(data) {
		$('.popover').html(data.result);
	};
	var error = function(data) {
		$('.popover').html('<font color=red>软件中心异常！</font>');
	};
	if(script =="ks_tar_install.sh"){
		setTimeout("get_log(1);", 200);
	}else{
		CheckX();
	}
	$.ajax({
		type: "POST",
		url: "/_api/",
		data: JSON.stringify(postData),
		success: success,
		error: error,
		dataType: "json"
	});
}
function changeButton(obj){
	if(obj){
		$('button').addClass('disabled');
		$('button').prop('disabled', true);
	}else{
		$('button').removeClass('disabled');
		$('button').prop('disabled', false);
	}
}
function checkInstallStatus(){
	$.getJSON("/_api/softcenter_installing_", function(resp) {
		appsInfo=resp.result[0];
		var installing  = appsInfo["softcenter_installing_status"];
		var name = appsInfo["softcenter_installing_todo"];
		if( name== "softcenter"){
			window.location.href='/cgi-bin/luci//admin/koolsoft#/soft-center-update.asp';
			return;
		}
		if(!installing || installing=="0"){
			currState.installing = false;
			clearTimeout(TimeOut);
			setTimeout("window.location.reload()", 3000);
		}else{
			currState.installing = true;
			changeButton(true);
			$('#23333').html(Msginfos[installing]);
		}
	});
}
function CheckX() {
	changeButton(true);
	$(window).scrollTop(0);
	layer.msg('\<\div style="padding: 7px;font-weight: 500;" id="23333">\<\/div>', {
		shade: 0.8,
		scrollbar: false,
		offset: '400px',
		area: '420px',
		time: 0
	});
	TimeOut = window.setInterval(checkInstallStatus, 200);
}
function softCenterInit(){
	$.getJSON("/_api/softcenter_", function(resp) {
		appsInfo=resp.result[0];
		getSoftCenter(appsInfo);
		if(resp.softcenter_installing_status != '0' && resp.softcenter_installing_status){
			CheckX();
		}
		get_log();
	});
}
function uploadApp(){
	var filename = $("#file").val();
	filename = filename.split('\\');
	filename = filename[filename.length-1];
	var filelast = filename.split('.');
	filelast = filelast[filelast.length-1];
	if(filelast !='gz'){
		alert('插件压缩包格式不正确！');
		return false;
	}
	var formData = new FormData();
	formData.append(filename, $('#file')[0].files[0]);
	$('.popover').html('正在安装，请稍后……');
	changeButton(true);
	$.ajax({
		url: '/_upload',
		type: 'POST',
		cache: false,
		data: formData,
		processData: false,
		contentType: false,
		complete:function(res){
			if(res.status==200){
				var moduleInfo = {
						"name":filename,
					};
				appPostScript(moduleInfo,'ks_tar_install.sh');
			}
		}
	});
}
function get_log(s){
	$.ajax({
		url: '/_temp/soft_log.txt',
		type: 'GET',
		dataType: 'html',
		async: true,
		cache:false,
		success: function(response) {
			var retArea = E("soft_log");
			if (response.search("jobdown") != -1) {
				retArea.value = response.replace("jobdown", " ");
				retArea.scrollTop = retArea.scrollHeight;
				if(s){
					$('.popover').html('安装成功！页面即将跳转！');
					clearTimeout(TimeOut);
					setTimeout("window.location.reload()", 3000);
				}
				return true;
			}
			if (_responseLen == response.length) {
				noChange++;
			} else {
				noChange = 0;
			}
			if (noChange > 8000) {
				return false;
			} else {
				setTimeout("get_log(1);", 400);
			}
			retArea.value = response;
			retArea.scrollTop = retArea.scrollHeight;
			_responseLen = response.length;
		},
		error: function(xhr, status, error) {
			if(s){
				$('.popover').html('服务器出错，请稍候再试！');
				changeButton(false);
			}
		}
	});
}
function save_extra_now(arg){
	var dbus2 = {};
	dbus2["softcenter_extra_url"] = E("_softcenter_extra_url").value;
	var id = parseInt(Math.random() * 100000000);
	var postData = {"id": id, "method": "dummy_script.sh", "params":[], "fields": dbus2};
	$.ajax({
		type: "POST",
		url: "/_api/",
		async: true,
		cache:false,
		data: JSON.stringify(postData),
		dataType: "json",
		success: function(response){
			if(response){
				setTimeout("window.location.reload()", 300);
				return true;
			}
		}
	});
}
function init_soft(){
	init_softcenter_layout();
	layer_show();
}
function layer_show(){
		$('#github_png').on('click', function() {
			layer.open({
				type: 2,
				area: ['780px', '450px'],
				fixed: false, //不固定
				maxmin: true,
				content: 'http://ip.koolcenter.com/all'
			});
		});
}
function init_softcenter_layout() {
	var SCREEN_WIDTH = $(document).width();
	if (!cookie.get('softcenterlayout')) {
		cookie.set('softcenterlayout', 1);
	}
	if (cookie.get('softcenterlayout') == '1') {
		$("#softcenter_layout_switch").attr("class", "narrow");
		$(".box, ul.nav.nav-tabs, .col").css("max-width", "1332px")
		$(".box, ul.nav.nav-tabs, .col").css("min-width", "1072px")
		$("#softcenterlayout_switch").html('<i class="icon-chevron-left"></i><i class="icon-chevron-right"></i>');
	} else {
		$("#softcenter_layout_switch").attr("class", "wide");
		$(".box, ul.nav.nav-tabs, .col").css("max-width", "100%");
		$(".box, ul.nav.nav-tabs, .col").css("min-width", "20%");
		$("#softcenter_layout_switch").html('<i class="icon-chevron-right"></i><i class="icon-chevron-left"></i>');
	}
}
function switch_layout() {
	var SCREEN_WIDTH = $(document).width();
	if ($("#softcenter_layout_switch").hasClass("narrow")) {
		$("#softcenter_layout_switch").attr("class", "wide");
		$(".box, ul.nav.nav-tabs, .col").css("max-width", "100%");
		$(".box, ul.nav.nav-tabs, .col").css("min-width", "20%");
		$("#softcenter_layout_switch").html('<i class="icon-chevron-right"></i><i class="icon-chevron-left"></i>');
		cookie.set('softcenterlayout', 0);
	} else {
		$("#softcenter_layout_switch").attr("class", "narrow");
		$(".box, ul.nav.nav-tabs, .col").css("max-width", "1332px");
		$(".box, ul.nav.nav-tabs, .col").css("min-width", "1072px")
		$("#softcenter_layout_switch").html('<i class="icon-chevron-left"></i><i class="icon-chevron-right"></i>');
		cookie.set('softcenterlayout', 1);
	}
}
</script>
	<div class="box">
		<div class="heading">
			<div id="loading"><br><b>正在连接服务器...</b> <div class="spinner"></div></div>
			<div class="loader" style="display:none;">
				<div class="loading-2">
					<i></i>
					<i></i>
					<i></i>
					<i></i>
					<i></i>
				</div>
			</div>
			<span id="server" style="color:#FF6A6A;font-size:13px;margin-right:10px;"></span>
			<span id="version" style="color:#FF6A6A;font-size:13px;"></span>
			<button id="update" style="display:none;float:right;margin-top:-10px" class="btn btn-success pull-right">有新的版本可用 <i class="icon-system"></i></button>
			<a id="softcenter_layout_switch" class="narrow" onclick="switch_layout();" style="float:right;border-radius:3px;margin-right:5px;margin-top:-10px;font-size: 13px;cursor: pointer"><i class="icon-chevron-right"></i><i class="icon-chevron-left"></i></a>
		</div>
		<br>
		<div class="content">
			<fieldset>
				<div class="col-sm-2" style="width:130px">
					<img class="pull-left" id="github_png" style="width:110px" src="/res/github.png">
				</div>
				<div class="col-sm-10">
					<ul class="pullmsg" style="margin-left: 35px;">
						<li id="push_titile">
							欢迎
						</li>
						<li id="push_content1">
							欢迎来到插件中心，目前正在紧张开发中，各种插件酝酿中！
						</li>
						<li id="push_content2">
							如果你想加入我们的工作，在 <a href="http://www.koolshare.cn" target="_blank"> <i><u>www.koolshare.cn</u></i> </a>联系我们！
						</li>
						<li id="push_content3"></li>
						<li id="push_content4"></li>
					</ul>
				</div>
			</fieldset>
		</div>
	</div>
	​<ul class="nav nav-tabs">
		<li><a href="javascript:void(0);" onclick="tabSelect('app1');" id="app1-server1-basic-tab" class="active"><i class="icon-system"></i> 已安装</a></li>
		<li><a href="javascript:void(0);" onclick="tabSelect('app2');" id="app2-server1-advanced-tab"><i class="icon-globe"></i> 未安装</a></li>
		<li><a href="javascript:void(0);" onclick="tabSelect('app3');" id="app3-server1-keys-tab"><i class="icon-tools"></i> 离线安装</a></li>
		<li><a href="javascript:void(0);" onclick="tabSelect('app4');" id="app4-server1-status-tab"><i class="icon-info"></i> 关于我们</a></li>
		<span id="overlay_status" style="float:right;margin-right:5px;margin-top:0px;display: none;" class="td left"><div id="overlay_status_text" style="font-size: 12px;min-width: 270px;" class="cbi-progressbar"><div></div></div></span>
		
	</ul>
	<div class="box boxr1">
		<div class="heading">已安装软件列表&nbsp;&nbsp;&nbsp;<span class="popover"></span></div>
		<div class="content">
			<div class="tabContent1">
			</div>
		</div>
	</div>
	<div class="box boxr2">
		<div class="heading">未安装软件列表&nbsp;&nbsp;&nbsp;<span class="popover"></span></div>
		<div class="content">
			<div class="tabContent2">
			</div>
		</div>
	</div>
	<div class="box boxr3">
		<div class="heading">插件离线安装界面&nbsp;&nbsp;&nbsp;<span class="popover"></span></div>
		<div class="content">
			<div class="tabContent3">
				<ul style="margin-left: 30px;">
					<li>通过本页面，你可以上传插件的离线安装包来安装插件；</li>
					<li>离线安装会自动解压tar.gz后缀的压缩包，识别压缩包一级目录下的install.sh文件并执行；</li>
				</ul>
				<br/>
				<div id="identification" class="section">
					<fieldset>
						<label class="control-left-label col-sm-3">选择安装包</label>
						<div class="col-sm-9">
							<input type="file" id="file" size="50">
							<button id="upload" type="button"  onclick="uploadApp();" class="btn btn-danger">上传并安装 <i class="icon-cloud"></i></button>
						</div>
					</fieldset>
					<fieldset>
						<label class="control-left-label col-sm-3">安装日志</label>
						<div class="col soft_log">
							<script type="text/javascript">
								s = 'height:300px;display:block';
								$('.col.soft_log').append('<textarea class="as-script" name="soft_log" id="soft_log" wrap="off" style="max-width:100%; min-width: 99%;' + s + '" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled></textarea>');
							</script>
						</div>
					</fieldset>
				</div>
			</div>
		</div>
	</div>
	<div class="box boxr4">
		<div class="heading">关于我们</div>
		<div class="content">
			<div class="tabContent4">
				<ul style="margin-left: 30px;">
					<li>我们是一群致力于服务大众的个人自发的群体，来自全国各地都聚集在 <a href="http://koolshare.cn" target="_blank"><font color="#FF6347"> KoolShare </font></a>论坛。</li>
					<li><font color="#8470FF">参与开发的人员：@小宝、@fw867、@sadog、@JSmonkey、@HOUZI(｡◕‿&nbsp;&nbsp;◕｡)、KoolShare开发组、以及其他人员。</font></li>
					<li><font color="#1E90FF">本软件中心属于开源项目，任何组织或个人均可自由开发。</font></li>
					<li>软件中心目前处于测试阶段，如在使用中出现问题请至 <a href="http://koolshare.cn/forum-97-1.html" target="_blank"><font color="#FF6347">KoolShare LEDE</font></a> 版块反馈。</li>
				</ul>
			</div>
		</div>
	</div>
	<script type="text/javascript">init_soft();</script>
</content>
